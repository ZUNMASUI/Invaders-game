<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>インベーダー</title>
</head>

<body>
  <canvas id="canvas" style="background-color: rgb(76, 83, 83)" width="800" height="500"></canvas>
  <script>
    "use strict";
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let enemyCharacters = []; //敵キャラの配列要素が入る配列
    let bullets = [];//生成された攻撃の弾の情報が入る配列
    const endImage = new Image();//ゲームオーバの情報を入れる変数
    endImage.src = "/Users/masuishintarou/Documents/GitHub/Invaders-game/gameover.jpeg";
    const clearImage = new Image();//ゲームクリアの情報を入れる変数
    clearImage.src = "/Users/masuishintarou/Documents/GitHub/Invaders-game/gameclear.png";
    const hp = 30;//自機の体力
    const MUTEKI_INTERVAL = 5;//ダメージを受けた後の無敵時間


    //ゲーム全体をコントロールクラス
    class Game {

      //三平方の定理を使って、距離を判定するメソッド
      calcDistance() {
        return Math.sqrt(Math.pow(this.x - x, 2) + Math.pow(this.y - y, 2));
      }

      //マイフレーム実行するメソッド
      mainloop() {
        ctx.clearRect(0, 0, 800, 500)
        chara.draw();
        chara.hitCheck();
        enemyCharacters.forEach((enemy) => {
          enemy.draw();
          enemy.death();
        });
        bullets.forEach((bullet) => {
          bullet.draw();
          // bullet.death();
        });

        requestAnimationFrame(mainloop); Ï
      }
      //指定したデータを描くメソッド
      draw() {
        ctx.drawImage();
      }

      //ゲームオーバー画面を呼ぶメソッド
      gameover() {
        if (hp <= 0) {
          ctx.drawImage(endImage, 0, 0, 800, 500);
        }
      }
      //ゲームクリア画面を呼ぶメソッド
      gameclear() {
        if (enemyCharacters.length === 0) {
          ctx.drawImage(clearImage, 0, 0, 800, 500);
        }
      }
    }

    //敵キャラクラス
    class Enemy {
      constructor(x, y) {
        this.x = x //x座標
        this.y = y //y座標
        this.speedX = 3; //マイフレームx座標を動く速さ
        this.speedY = 2.5;//マイフレームy座標を動く速さ
        this.image = new Image();//敵キャラの画像情報についての変数
        this.image.src = "/Users/masuishintarou/Documents/GitHub/Invaders-game/pipo-enemy003.png";
      }

      //決まった一定の動きをした結果を描画する
      move() {
        this.x += this.speedX;
        this.y += this.speedY;
        if (this.x > 800 || this.x < 0) {
          this.speedX = this.speedX * -1.2;
        }
        if (this.y > 500) {
          this.y = -30;
        }
        //ctx.drawImage(this.image, this.x, this.y, 70, 70)
      }

      //自分自身の描画を消す 変更要！！
      death() {
        var distance = this.calcDistance(bullet);
        if (distance <= 35) {
            enemyCharacters = enemyCharacters.filter((enemy) => enemy !== this)
          }
        }
      }

      //敵キャラの配列にランダムでx.y座標を格納するメソッド
      generate() 
        for (let i = 0; i < 10; i++) {
          let x = Math.floor(Math.random() * 800);
          let y = Math.floor(Math.random() * 100);
          const eneChara = new Enemy(x, y);
          enemyCharacters.push(eneChara);
        }
      


    //自機キャラのクラス
    class Character {
      constructor(x, y) {
        this.x = x
        this.y = y
        this.image = new Image();
        this.image.src = "/Users/masuishintarou/Documents/GitHub/Invaders-game/騎士画像.png";
        this.hp = hp
        this.muteki_interval = 0;
      }

      //自機が【入力に応じて】動いた結果を描画する
      move() {
        let flame = Math.floor(this.muteki_interval) % 2;
        if (this.muteki_interval > 0 && flame === 0) {
          ctx.drawImage(this.image, this.x, this.y, 70, 70);
          ctx.fillStyle = '#f00';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
        } else {
          ctx.drawImage(this.image, this.x, this.y, 70, 70)
        }
      }


      //体力を減少させる
      damege() {
        if (distance <= 40) {
          this.hp -= 10;
          this.muteki_interval = MUTEKI_INTERVAL
          if (this.hp <= 0) {
            gameover();
          }
        }
      }

      //自分をcanvasから消す
      death() {

      }

      //当たり判定のメソッド
      hitCheck() {
        if (this.muteki_interval > 0) {
          return
        }
        enemyCharacters.forEach((enemy) => { //敵キャラとの距離がどれくらいから当たりかのコード
          var distance = this.calcDistance(enemy);
          if (distance <= 40) {
            this.hp -= 10;
            this.muteki_interval = MUTEKI_INTERVAL
            if (this.hp <= 0) {
              ctx.drawImage(endImage, 0, 0, 800, 500);
              stop();
            }
          }
        })
      }
      muteki() { //無敵判定に関するタイミングでのコード
        if (hp > 0 && this.muteki_interval == 0) {
          hitCheck();
        }
        if (this.muteki_interval > 0) {
          this.muteki_interval--;
        }
      }

      //弾オブジェクトのインスタンスを生成するメソッド
      attack() {
        const bullet = new Bullet(this.x, this.y - 30);
        bullets.push(bullet)
      }
    }


    const chara = new Character(350, 400); //自機の座標を持たせたインスタンス

    function keyDown(event) {//キーに関するコード
      console.log(event.code)
      switch (event.code) {
        case "ArrowRight":
          chara.x += 30;
          break;
        case "ArrowLeft":
          chara.x -= 30;
          break;
        case "ArrowUp":
          chara.y -= 15;
          break;
        case "ArrowDown":
          chara.y += 15;
          break;
        case "Space":
          chara.attack();
          break;
        default:
      }
    };
    window.onkeydown = keyDown

    //自機キャラが攻撃する時に出現する弾のクラス
    class Bullet {
      constructor(x, y) {
        this.x = x
        this.y = y
        this.speedY = -5;
        this.image = new Image();
        this.image.src = "/Users/masuishintarou/Documents/GitHub/Invaders-game/弾丸画像.png";
      }

      //弾の動きのメソッド
      move() { 
        this.y += this.speedY;
      }

      //canvasから消えるメソッド
      death() {
        
      }
    }
  </script>
</body>

</html>